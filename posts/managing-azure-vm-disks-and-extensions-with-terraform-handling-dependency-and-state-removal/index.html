<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal - mrtn.me</title><meta name=Description content="How to optimize the Terraform destroy process of Azure VMs with extensions and data disk attachments, including practical techniques for managing dependencies and bulk state removals."><meta property="og:url" content="http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/"><meta property="og:site_name" content="mrtn.me"><meta property="og:title" content="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal"><meta property="og:description" content="How to optimize the Terraform destroy process of Azure VMs with extensions and data disk attachments, including practical techniques for managing dependencies and bulk state removals."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-05T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-05T22:34:07+02:00"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="Azure"><meta property="article:tag" content="VM"><meta property="article:tag" content="Disks"><meta property="article:tag" content="Extensions"><meta property="article:tag" content="Infrastructure as Code"><meta name=twitter:card content="summary"><meta name=twitter:title content="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal"><meta name=twitter:description content="How to optimize the Terraform destroy process of Azure VMs with extensions and data disk attachments, including practical techniques for managing dependencies and bulk state removals."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/><link rel=prev href=http://mrtn.me/posts/2023/01/13/debugging-a-failing-openstack-image/><link rel=next href=http://mrtn.me/posts/2025/08/11/transferring-wsl-home-directories-between-distributions/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/mrtn.me\/posts\/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal\/"},"genre":"posts","keywords":"Terraform, Azure, VM, Disks, Extensions, Infrastructure as Code","wordcount":931,"url":"http:\/\/mrtn.me\/posts\/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal\/","datePublished":"2025-08-05T00:00:00+00:00","dateModified":"2025-08-05T22:34:07+02:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Antoine Martin"},"description":"How to optimize the Terraform destroy process of Azure VMs with extensions and data disk attachments, including practical techniques for managing dependencies and bulk state removals."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=mrtn.me>mrtn.me</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title="Blog posts">Posts </a><a class=menu-item href=/about/ title="About me">About </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=https://github.com/antoinemartin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=mrtn.me>mrtn.me</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title="Blog posts">Posts</a><a class=menu-item href=/about/ title="About me">About</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=https://github.com/antoinemartin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://linked.in/in/antoinemartin title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Antoine Martin</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=05-08>05-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;931 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#the-problem-terraform-deletes-extensions-and-disks-before-the-vm>The Problem: Terraform Deletes Extensions and Disks Before the VM</a></li><li><a href=#solution-overview-managing-dependencies-and-terraform-state>Solution Overview: Managing Dependencies and Terraform State</a><ul><li><a href=#1-remove-extensions-and-disk-attachments-from-terraform-state>1. Remove Extensions and Disk Attachments from Terraform State</a></li><li><a href=#2-enforce-disk-vm-destroy-ordering-using-depends_on>2. Enforce Disk-VM Destroy Ordering Using <code>depends_on</code></a></li><li><a href=#why-explicit-dependencies>Why Explicit Dependencies?</a></li></ul></li><li><a href=#summary-table-terraform-destroy-behavior-for-azure-vm-components>Summary Table: Terraform Destroy Behavior for Azure VM Components</a></li><li><a href=#final-recommendations>Final Recommendations</a><ul><li><a href=#complete-example-for-explicit-disk-dependency>Complete Example for Explicit Disk Dependency</a></li></ul></li><li><a href=#references-and-further-reading>References and Further Reading</a></li></ul></nav></div></div><div class=content id=content><p>When managing Azure Virtual Machines (VMs) with Terraform, especially Windows
VMs with extensions and attached data disks, it’s common to encounter challenges
around the order of resource destruction and avoiding unnecessary delays. This
post summarizes practical solutions to these issues, with example commands and
configuration snippets derived from a real-world scenario.</p><h2 id=the-problem-terraform-deletes-extensions-and-disks-before-the-vm>The Problem: Terraform Deletes Extensions and Disks Before the VM</h2><p>By default, Terraform tracks each Azure VM extension
(<code>azurerm_virtual_machine_extension</code>) and each data disk attachment
(<code>azurerm_virtual_machine_data_disk_attachment</code>) as independent resources. When
running <code>terraform destroy</code>, Terraform deletes these extensions and disk
attachments one by one <strong>before</strong> deleting the VM.</p><p>This sequence can slow down the destroy process and sometimes cause failures if
the VM or disks are not in the expected state. In Azure itself, deleting a VM
automatically deletes extensions attached to it, making explicit extension
destruction redundant.</p><p>Similarly, Terraform attempts to delete data disk attachments before the VM,
which would cause the disk to be actually unattached from the running VM, with
possible unexpected results.</p><h2 id=solution-overview-managing-dependencies-and-terraform-state>Solution Overview: Managing Dependencies and Terraform State</h2><h3 id=1-remove-extensions-and-disk-attachments-from-terraform-state>1. Remove Extensions and Disk Attachments from Terraform State</h3><p>To avoid Terraform explicitly deleting extensions and attachments, you can
<strong>remove these resources from Terraform state</strong>, so Terraform forgets about them
and lets Azure handle deletion cascades when the VM is deleted.</p><p>Use shell commands like these to bulk-remove all extensions or data disk
attachments from your state:</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-bash"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Remove all VM extensions from state</span>
</span></span><span class=line><span class=cl>terraform state rm <span class=k>$(</span>terraform state list <span class=p>|</span> grep azurerm_virtual_machine_extension<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Remove all data disk attachments from state</span>
</span></span><span class=line><span class=cl>terraform state rm <span class=k>$(</span>terraform state list <span class=p>|</span> grep azurerm_virtual_machine_data_disk_attachment<span class=k>)</span></span></span></code></pre></div></div><blockquote><p><strong>Note:</strong> Always back up your Terraform state file before performing bulk
state removals.</p></blockquote><div class="details admonition tip"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Backup & restore the terraform state<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>Before performing any bulk state operations, it&rsquo;s crucial to create a backup of
your Terraform state file. Here is the recommended approach:</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-bash"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Pull current state to a local backup file</span>
</span></span><span class=line><span class=cl>terraform state pull &gt; terraform.tfstate.backup.<span class=k>$(</span>date +%Y%m%d_%H%M%S<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Verify the backup contains your resources</span>
</span></span><span class=line><span class=cl>terraform show terraform.tfstate.backup.<span class=k>$(</span>date +%Y%m%d_%H%M%S<span class=k>)</span></span></span></code></pre></div></div><p><strong>To restore from backup if needed:</strong></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-bash"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># For remote state, push the backup back</span>
</span></span><span class=line><span class=cl>terraform state push terraform.tfstate.backup.20250105_143000</span></span></code></pre></div></div></div></div></div><h3 id=2-enforce-disk-vm-destroy-ordering-using-depends_on>2. Enforce Disk-VM Destroy Ordering Using <code>depends_on</code></h3><p>Simply removing disk attachments from state can cause Terraform to try deleting
disks before the VM, which fails if disks are still attached. The reliable fix
is to add explicit dependencies so Terraform destroys resources in the correct
order.</p><p>For example, in your VM resource definition, add a <code>depends_on</code> block
referencing the disks, ensuring Terraform deletes disks <strong>after</strong> the VM:</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-hcl"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;azurerm_windows_virtual_machine&#34; &#34;vm&#34;</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # VM configuration...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>  depends_on</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>azurerm_managed_disk</span><span class=p>.</span><span class=k>additionnal_disks</span><span class=p>,</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    # add all relevant disk attachment resources here
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><p>This setup tells Terraform: wait until those disk attachments are destroyed
before deleting the VM, avoiding the race condition that causes failure.</p><h3 id=why-explicit-dependencies>Why Explicit Dependencies?</h3><p>Terraform often establishes implicit dependencies through references, but these
sometimes represent only &ldquo;resource existence,&rdquo; not full &ldquo;readiness.&rdquo; Azure VM
extensions and disk attachments require the VM to be fully provisioned (or
deprovisioned) before related resources can be managed safely. The <code>depends_on</code>
attribute forces Terraform to respect this ordering.</p><h2 id=summary-table-terraform-destroy-behavior-for-azure-vm-components>Summary Table: Terraform Destroy Behavior for Azure VM Components</h2><table><thead><tr><th>Resource Type</th><th>Default Terraform Behavior</th><th>Recommended Action</th></tr></thead><tbody><tr><td>VM Extensions</td><td>Destroyed first, then VM</td><td>Remove from state before VM destroy, or leave as is if okay</td></tr><tr><td>Data Disk Attachments</td><td>Destroyed before VM</td><td>Use <code>depends_on</code> in VM to depend on disk attachments</td></tr><tr><td>Managed Disks</td><td>Destroyed after attachments</td><td>Generally safe with proper dependencies</td></tr><tr><td>VM</td><td>Destroy last</td><td>Ensure all dependencies cleared or ordered correctly</td></tr></tbody></table><h2 id=final-recommendations>Final Recommendations</h2><ul><li>When destroying VMs with extensions, <strong>remove extensions from Terraform
state</strong> to speed up destroy and rely on Azure&rsquo;s automatic cleanup.</li><li>For disks, <strong>do not remove disk attachments or disks from state blindly</strong>.
Instead, add explicit <code>depends_on</code> dependencies in the VM resource to ensure
Terraform respects the correct destroy order.</li><li>Always <strong>backup your Terraform state</strong> before any bulk operations.</li><li>For quick environment cleanup, consider deleting the whole resource group
which cascades deletes in Azure.</li></ul><p>Terraform allows robust, repeatable management of complex Azure infrastructures,
but some manual steps and explicit dependency handling are necessary to optimize
operations involving VMs with extensions and attached data disks.</p><p>The approach described here — combining state resource removals and dependency
declarations — has proven reliable in practice for ensuring clean, efficient VM
destruction workflows.</p><h3 id=complete-example-for-explicit-disk-dependency>Complete Example for Explicit Disk Dependency</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-hcl"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;azurerm_virtual_machine_data_disk_attachment&#34; &#34;data_disk_1&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  managed_disk_id</span>    <span class=o>=</span> <span class=k>azurerm_managed_disk</span><span class=p>.</span><span class=k>data_disk_1</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  virtual_machine_id</span> <span class=o>=</span> <span class=k>azurerm_windows_virtual_machine</span><span class=p>.</span><span class=k>vm</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  lun</span>               <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>  caching</span>           <span class=o>=</span> <span class=s2>&#34;ReadOnly&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;azurerm_windows_virtual_machine&#34; &#34;vm&#34;</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # VM configuration...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>  depends_on</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=k>azurerm_virtual_machine_data_disk_attachment</span><span class=p>.</span><span class=k>data_disk_1</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><p>Using these techniques will help you avoid errors during destruction and save
time by preventing Terraform from destroying extensions and disk attachments
needlessly.</p><p>If you have questions or want to share more tips on Terraform with Azure, feel
free to comment below!</p><hr><h2 id=references-and-further-reading>References and Further Reading</h2><p>For additional information on the topics covered in this post, consider these
resources:</p><p><strong>Terraform Azure Provider Documentation</strong></p><ul><li><a href=https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_machine_data_disk_attachment.html target=_blank rel="noopener noreffer">Virtual Machine Data Disk Attachment Resource</a> -
Official documentation for managing disk attachments</li><li><a href=https://learn.microsoft.com/en-us/azure/developer/terraform/ target=_blank rel="noopener noreffer">Azure Terraform Developer Guide</a> -
Microsoft&rsquo;s comprehensive guide to using Terraform with Azure</li></ul><p><strong>Dependency Management Best Practices</strong></p><ul><li><a href=https://iamachs.com/blog/azure-terraform/part-5-mastering-dependencies/ target=_blank rel="noopener noreffer">Mastering Dependencies in Azure Terraform</a> -
In-depth guide on handling complex resource dependencies</li><li><a href=https://spacelift.io/blog/terraform-depends-on target=_blank rel="noopener noreffer">Understanding Terraform depends_on</a> -
Comprehensive explanation of explicit dependency management</li></ul><p><strong>Community Solutions and Examples</strong></p><ul><li><a href=https://github.com/Azure/terraform-azurerm-avm-res-compute-virtualmachine/blob/main/main.disks.tf target=_blank rel="noopener noreffer">Azure VM Module with Managed Disks</a> -
Production-ready example from Azure&rsquo;s official VM module</li><li><a href=https://stackoverflow.com/questions/55344773/terraform-azure-how-to-configure-type-of-data-disks-when-vm-is-provisioned-from target=_blank rel="noopener noreffer">Data Disk Configuration Discussion</a> -
Community solutions for VM provisioning with data disks</li></ul><p><strong>Advanced Topics</strong></p><ul><li><a href=https://library.tf/modules/Azure/diskencrypt/azurerm/latest target=_blank rel="noopener noreffer">Terraform Azure Disk Encryption Module</a> -
For implementing disk encryption at rest</li><li><a href="https://www.youtube.com/watch?v=fj261U4tK2A" target=_blank rel="noopener noreffer">Terraform Azure VM Dependencies Tutorial</a> -
Video walkthrough of dependency management</li></ul><p><strong>Known Issues and Workarounds</strong></p><ul><li><a href=https://github.com/hashicorp/terraform-provider-azurerm/issues/28887 target=_blank rel="noopener noreffer">Azure Provider Issue #28887</a> -
Tracking ongoing improvements to VM resource management</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 05-08&nbsp;<a class=git-hash href=https://github.com/antoinemartin/antoinemartin.github.io/commit/18a93fd95458dc7891e6c159099c0c6f1c529331 target=_blank title="commit by Antoine Martin(antoine.martin@octave.biz) 18a93fd95458dc7891e6c159099c0c6f1c529331: ✨ Add blog post on managing Azure VM disks and extensions with Terraform">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>18a93fd</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on X" data-sharer=x data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-title="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal" data-via=antoinemartin data-hashtags="Terraform,Azure,VM,Disks,Extensions,Infrastructure as Code"><i class="fab fa-x-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Threads" data-sharer=threads data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-title="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal"><i class="fab fa-threads fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-hashtag=Terraform><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-title="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-title="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-title="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Diaspora" data-sharer=diaspora data-url=http://mrtn.me/posts/managing-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal/ data-title="Managing Azure VM Disks and Extensions with Terraform: Handling Dependency and State Removal" data-description="How to optimize the Terraform destroy process of Azure VMs with extensions and data disk attachments, including practical techniques for managing dependencies and bulk state removals."><i class="fab fa-diaspora fa-fw" aria-hidden=true></i></a><a href="https://t.me/share/url?url=http%3a%2f%2fmrtn.me%2fposts%2fmanaging-azure-vm-disks-and-extensions-with-terraform-handling-dependency-and-state-removal%2f&amp;text=Managing%20Azure%20VM%20Disks%20and%20Extensions%20with%20Terraform%3a%20Handling%20Dependency%20and%20State%20Removal" target=_blank title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/terraform/>Terraform</a>,&nbsp;<a href=/tags/azure/>Azure</a>,&nbsp;<a href=/tags/vm/>VM</a>,&nbsp;<a href=/tags/disks/>Disks</a>,&nbsp;<a href=/tags/extensions/>Extensions</a>,&nbsp;<a href=/tags/infrastructure-as-code/>Infrastructure as Code</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2023/01/13/debugging-a-failing-openstack-image/ class=prev rel=prev title="Debugging a failing OpenStack image"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Debugging a failing OpenStack image</a>
<a href=/posts/2025/08/11/transferring-wsl-home-directories-between-distributions/ class=next rel=next title="Transferring WSL Home Directories Between Distributions">Transferring WSL Home Directories Between Distributions<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.148.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2012 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://linked.in/in/antoinemartin target=_blank>Antoine Martin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script src=https://geekquickies.disqus.com/embed.js defer></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js></script><script>window.config={comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script src=/js/theme.min.js></script></body></html>