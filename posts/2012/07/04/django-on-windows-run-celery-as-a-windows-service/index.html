<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Django on Windows: Run Celery as a Windows Service - mrtn.me</title><meta name=Description content><meta property="og:title" content="Django on Windows: Run Celery as a Windows Service"><meta property="og:description" content="In my previous post, I showed how to set up a Django project on a Windows Server to be served behind IIS. After setting up the server, the next thing we want with a Django application is to be able to run background and scheduled tasks, and Celery is the perfect tool for that.
On Windows, background processes are mostly run as Windows Services. Fortunately, Python for Windows Extensions (a.k.a pywin32) provides facilities to create a Windows Service."><meta property="og:type" content="article"><meta property="og:url" content="http://mrtn.me/posts/2012/07/04/django-on-windows-run-celery-as-a-windows-service/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-07-04T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-02T21:50:20+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Django on Windows: Run Celery as a Windows Service"><meta name=twitter:description content="In my previous post, I showed how to set up a Django project on a Windows Server to be served behind IIS. After setting up the server, the next thing we want with a Django application is to be able to run background and scheduled tasks, and Celery is the perfect tool for that.
On Windows, background processes are mostly run as Windows Services. Fortunately, Python for Windows Extensions (a.k.a pywin32) provides facilities to create a Windows Service."><meta name=application-name content="mrtn.me"><meta name=apple-mobile-web-app-title content="mrtn.me"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://mrtn.me/posts/2012/07/04/django-on-windows-run-celery-as-a-windows-service/><link rel=prev href=http://mrtn.me/posts/2012/06/27/running-django-under-windows-with-iis-using-fcgi/><link rel=next href=http://mrtn.me/posts/2012/07/06/installing-redmine-on-centos-6-dot-2-wiht-mysql-and-apache/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Django on Windows: Run Celery as a Windows Service","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/mrtn.me\/posts\/2012\/07\/04\/django-on-windows-run-celery-as-a-windows-service\/"},"genre":"posts","keywords":"old, obsolete, django, celery, windows","wordcount":1272,"url":"http:\/\/mrtn.me\/posts\/2012\/07\/04\/django-on-windows-run-celery-as-a-windows-service\/","datePublished":"2012-07-04T00:00:00+00:00","dateModified":"2022-05-02T21:50:20+02:00","publisher":{"@type":"Organization","name":"Antoine Martin"},"author":{"@type":"Person","name":"Antoine Martin"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=mrtn.me>mrtn.me</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title="Blog posts">Posts </a><a class=menu-item href=/about/ title="About me">About </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=https://github.com/antoinemartin title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=mrtn.me>mrtn.me</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title="Blog posts">Posts</a><a class=menu-item href=/about/ title="About me">About</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=https://github.com/antoinemartin title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Django on Windows: Run Celery as a Windows Service</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://linked.in/in/antoinemartin title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Antoine Martin</a></span>&nbsp;<span class=post-category>included in <a href=/categories/devops/><i class="far fa-folder fa-fw"></i>DevOps</a>&nbsp;<a href=/categories/django/><i class="far fa-folder fa-fw"></i>Django</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=04-07>04-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1272 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#configuring-your-project>Configuring your project</a></li><li><a href=#enabling-the-service>Enabling the service</a></li><li><a href=#configuring-the-service>Configuring the service</a></li><li><a href=#installing-and-removing-the-service>Installing and removing the service</a></li><li><a href=#starting-and-stopping-the-service>Starting and stopping the service</a></li><li><a href=#running-the-beat-service>Running the Beat service</a></li><li><a href=#changes-to-the-configuration>Changes to the configuration</a></li><li><a href=#running-arbitrary-commands>Running arbitrary commands</a></li></ul></nav></div></div><div class=content id=content><p>In my
<a href=/posts/2012/06/27/running-django-under-windows-with-iis-using-fcgi/ rel>previous post</a>,
I showed how to set up a Django project on a Windows Server to be served behind
IIS. After setting up the server, the next thing we want with a Django
application is to be able to run background and scheduled tasks, and
<a href=http://celeryproject.org/ target=_blank rel="noopener noreffer">Celery</a> is the perfect tool for that.</p><p>On Windows, background processes are mostly run as Windows Services.
Fortunately,
<a href=http://sourceforge.net/projects/pywin32/ target=_blank rel="noopener noreffer">Python for Windows Extensions</a> (a.k.a
pywin32) provides facilities to create a Windows Service.</p><p>I have packaged the related code for this post and the previous one in a project
called
<a href=https://github.com/antoinemartin/django-windows-tools target=_blank rel="noopener noreffer">django-windows-tools</a>
available on github and the cheese shop. To make it available for your
application, simply install it with the command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>pip install django-windows-tools
</span></span></code></pre></td></tr></table></div></div><h2 id=configuring-your-project>Configuring your project</h2><p>To run Celery for your project, you need to install Celery and choose a Broker
for passing messages between the Django application and the Celery worker
processes.</p><p>Installation of celery is easy:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-posh data-lang=posh><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>pip</span> <span class=n>install</span> <span class=nb>django-celery</span>
</span></span></code></pre></td></tr></table></div></div><p>Then you add it to your <code>settings.py</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>INSTALLED_APPS</span> <span class=o>+=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;djcelery&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>djcelery</span>
</span></span><span class=line><span class=cl><span class=n>djcelery</span><span class=o>.</span><span class=n>setup_loader</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>You can choose among
<a href=http://docs.celeryproject.org/en/latest/getting-started/brokers/index.html target=_blank rel="noopener noreffer">several message brokers</a>.
I personnaly use a <a href=https://github.com/MSOpenTech/Redis target=_blank rel="noopener noreffer">Windows port of Redis</a>
installed as a
<a href=https://github.com/kcherenkov/redis-windows-service target=_blank rel="noopener noreffer">Windows Service</a>. The
advantage of Redis is that it can also be used as an in-memory database. In case
you&rsquo;re interested, you can find <a href=/downloads/redis.zip rel>here</a> a binay copy of my
installation.</p><p>The configuration of Redis as Celery&rsquo;s broker also occurs in the <code>settings.py</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Redis configuration</span>
</span></span><span class=line><span class=cl><span class=n>REDIS_PORT</span><span class=o>=</span><span class=mi>6379</span>
</span></span><span class=line><span class=cl><span class=n>REDIS_HOST</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>REDIS_DB</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>REDIS_CONNECT_RETRY</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Broker configuration</span>
</span></span><span class=line><span class=cl><span class=n>BROKER_HOST</span> <span class=o>=</span> <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>BROKER_BACKEND</span><span class=o>=</span><span class=s2>&#34;redis&#34;</span>
</span></span><span class=line><span class=cl><span class=n>BROKER_USER</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>BROKER_PASSWORD</span> <span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>BROKER_VHOST</span> <span class=o>=</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Celery Redis configuration</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_SEND_EVENTS</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_RESULT_BACKEND</span><span class=o>=</span><span class=s1>&#39;redis&#39;</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_REDIS_HOST</span><span class=o>=</span><span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_REDIS_PORT</span><span class=o>=</span><span class=mi>6379</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_REDIS_DB</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_TASK_RESULT_EXPIRES</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>CELERYBEAT_SCHEDULER</span><span class=o>=</span><span class=s2>&#34;djcelery.schedulers.DatabaseScheduler&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CELERY_ALWAYS_EAGER</span><span class=o>=</span><span class=kc>False</span>
</span></span></code></pre></td></tr></table></div></div><p>Finally, you add the <code>django_windows_tools</code> application to your project:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>INSTALLED_APPS</span> <span class=o>+=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;django_windows_tools&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>After the configuration, a <code>python manage.py syncdb</code> will ensure that the
database of your project is up to date.</p><h2 id=enabling-the-service>Enabling the service</h2><p>The installed service is going to allow us to run in the backround arbitrary
management commands related to our project.</p><p>With the application installed, on the root of your project, type the following
command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>D:\sites\mydjangoapp&gt; python winservice_install
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_install.png data-srcset="/images/django/winservice_install.png, /images/django/winservice_install.png 1.5x, /images/django/winservice_install.png 2x" data-sizes=auto alt=/images/django/winservice_install.png title=img></p><p>It will create two files in the root directory of your project .<code>service.py</code>
will help you install, run and remove the Windows Service. It&rsquo;s much like
<code>manage.py</code> for the service. <code>service.ini</code> contains the list of management
commands that will be run by the Windows Service.</p><h2 id=configuring-the-service>Configuring the service</h2><p>A look at the <code>service.ini</code> file gives us the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>    <span class=k>[services]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Services to be run on all machines</span>
</span></span><span class=line><span class=cl>    <span class=na>run</span><span class=o>=</span><span class=s>celeryd
</span></span></span><span class=line><span class=cl><span class=s>    clean=d:\logs\celery.log</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>[BEATSERVER]</span>
</span></span><span class=line><span class=cl>    <span class=c1># There should be only one machine with the celerybeat service</span>
</span></span><span class=line><span class=cl>    <span class=na>run</span><span class=o>=</span><span class=s>celeryd celerybeat
</span></span></span><span class=line><span class=cl><span class=s>    clean=d:\logs\celerybeat.pid;d:\logs\beat.log;d:\logs\celery.log</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>[celeryd]</span>
</span></span><span class=line><span class=cl>    <span class=na>command</span><span class=o>=</span><span class=s>celeryd
</span></span></span><span class=line><span class=cl><span class=s>    parameters=-f d:\logs\celery.log -l info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>[celerybeat]</span>
</span></span><span class=line><span class=cl>    <span class=na>command</span><span class=o>=</span><span class=s>celerybeat
</span></span></span><span class=line><span class=cl><span class=s>    parameters=-f d:\logs\beat.log -l info --pidfile=d:\logs\celerybeat.pid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>[runserver]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Runs the debug server and listen on port 8000</span>
</span></span><span class=line><span class=cl>    <span class=c1># This one is just an example to show that any manage command can be used</span>
</span></span><span class=line><span class=cl>    <span class=na>command</span><span class=o>=</span><span class=s>runserver
</span></span></span><span class=line><span class=cl><span class=s>    parameters=--noreload --insecure 0.0.0.0:8000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>[log]</span>
</span></span><span class=line><span class=cl>    <span class=na>filename</span><span class=o>=</span><span class=s>d:\logs\service.log
</span></span></span><span class=line><span class=cl><span class=s>    level=INFO</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>services</code> section contains :</p><ul><li>The list of background commands to run in the <code>run</code> directive.</li><li>The list of files to delete when refreshed or stopped in the <code>clean</code>
directive.</li></ul><p>Here the <code>run</code> directive contains only one command: <code>celeryd</code>. If we look at the
corresponding section of the <code>ini</code> file, we find:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>    <span class=k>[celeryd]</span>
</span></span><span class=line><span class=cl>    <span class=na>command</span><span class=o>=</span><span class=s>celeryd
</span></span></span><span class=line><span class=cl><span class=s>    parameters=-f d:\logs\celery.log -l info</span>
</span></span></code></pre></td></tr></table></div></div><p><code>command</code> specifies the <code>manage.py</code> command to run and <code>parameters</code> specifies
the parameters to the command.</p><p>So here the configurations tells us that the service, when started, will run a
python process equivalent to the command line:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-posh data-lang=posh><span class=line><span class=cl>  <span class=n>D:</span><span class=p>\</span><span class=n>sites</span><span class=p>\</span><span class=n>mydjangoapp</span><span class=p>&gt;</span> <span class=n>python</span> <span class=n>manage</span><span class=p>.</span><span class=n>py</span> <span class=n>celeryd</span> <span class=o>-f</span> <span class=n>d:</span><span class=p>\</span><span class=n>logs</span><span class=p>\</span><span class=n>celery</span><span class=p>.</span><span class=n>log</span> <span class=n>-l</span> <span class=n>info</span>
</span></span></code></pre></td></tr></table></div></div><p>And that the <code>d:\logs\celery.log</code> will be deleted between runs.</p><p>The <code>log</code> sections defines a log file and logging level for the service process
itself:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>    <span class=k>[log]</span>
</span></span><span class=line><span class=cl>    <span class=na>filename</span><span class=o>=</span><span class=s>d:\logs\service.log
</span></span></span><span class=line><span class=cl><span class=s>    level=INFO</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=installing-and-removing-the-service>Installing and removing the service</h2><p>You need to have administrator privileges to install the service in the Windows
Registry so that it&rsquo;s started each time the machine boots. You do that with the
following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-posh data-lang=posh><span class=line><span class=cl><span class=n>D:</span><span class=p>\</span><span class=n>sites</span><span class=p>\</span><span class=n>mydjangoapp</span><span class=p>&gt;</span> <span class=n>python</span> <span class=n>service</span><span class=p>.</span><span class=n>py</span> <span class=p>-</span><span class=n>-startup</span><span class=p>=</span><span class=n>auto</span> <span class=n>install</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_install.png data-srcset="/images/django/winservice_install.png, /images/django/winservice_install.png 1.5x, /images/django/winservice_install.png 2x" data-sizes=auto alt=/images/django/winservice_install.png title=img></p><p>The <code>--startup=auto</code> parameter will allow the service to start automatically
when the server boots. You can check it has been installed:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_service.png data-srcset="/images/django/winservice_service.png, /images/django/winservice_service.png 1.5x, /images/django/winservice_service.png 2x" data-sizes=auto alt=/images/django/winservice_service.png title=img></p><p>It can be removed with the following commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-posh data-lang=posh><span class=line><span class=cl><span class=n>D:</span><span class=p>\</span><span class=n>sites</span><span class=p>\</span><span class=n>mydjangoapp</span><span class=p>&gt;</span> <span class=n>python</span> <span class=n>service</span><span class=p>.</span><span class=n>py</span> <span class=n>remove</span>
</span></span></code></pre></td></tr></table></div></div><p>Please ensure that the Server Manager is not running when you run this command,
because in that case a complete removal of the service will need a server
restart.</p><h2 id=starting-and-stopping-the-service>Starting and stopping the service</h2><p>The service can be manually started and stopped with the following commands:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-posh data-lang=posh><span class=line><span class=cl><span class=n>D:</span><span class=p>\</span><span class=n>sites</span><span class=p>\</span><span class=n>mydjangoapp</span><span class=p>&gt;</span> <span class=n>python</span> <span class=n>service</span><span class=p>.</span><span class=n>py</span> <span class=nb>start
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=n>D:</span><span class=p>\</span><span class=n>sites</span><span class=p>\</span><span class=n>mydjangoapp</span><span class=p>&gt;</span> <span class=n>python</span> <span class=n>service</span><span class=p>.</span><span class=n>py</span> <span class=n>stop</span>
</span></span></code></pre></td></tr></table></div></div><p>If everything went fine, the python processes should be there:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_process.png data-srcset="/images/django/winservice_process.png, /images/django/winservice_process.png 1.5x, /images/django/winservice_process.png 2x" data-sizes=auto alt=/images/django/winservice_process.png title=img></p><p>Along with the log files :</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_logs.png data-srcset="/images/django/winservice_logs.png, /images/django/winservice_logs.png 1.5x, /images/django/winservice_logs.png 2x" data-sizes=auto alt=/images/django/winservice_logs.png title=img></p><h2 id=running-the-beat-service>Running the Beat service</h2><p>If you deploy your Django project on several servers, you probably want to have
Celery worker processes on each deployed machine but only one unique Beat
process for executing scheduled tasks. You can customize the <code>services</code> section
of the <code>service.ini</code> configuration file on that specific machine, but this is
incovenient if you are sharing files between machines, for instance.</p><p>The service provides the ability to have several <code>services</code> sections in the same
configuration file for different host servers. The Windows Service will try to
find the section which name matches the name of the current server and will
fallback to the <code>services</code> section if it does not find it. This allows you to
have a different behaviour for the service on different machines. In the
preceding configuration, you have one section, named <code>BEATSERVER</code> :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>    <span class=k>[BEATSERVER]</span>
</span></span><span class=line><span class=cl>    <span class=c1># There should be only one machine with the celerybeat service</span>
</span></span><span class=line><span class=cl>    <span class=na>run</span><span class=o>=</span><span class=s>celeryd celerybeat
</span></span></span><span class=line><span class=cl><span class=s>    clean=d:\logs\celerybeat.pid;d:\logs\beat.log;d:\logs\celery.log</span>
</span></span></code></pre></td></tr></table></div></div><p>which adds the <code>celerybeat</code> command to the <code>celeryd</code> command. With this
configuration file, the service run on a machine named <code>BEATSERVER</code> will run the
Celery beat service.</p><p>The <code>winservice_install</code> facility provides a convenient option for choosing the
current machine as the <em>Beat</em> machine. Let&rsquo;s try that :</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_beat.png data-srcset="/images/django/winservice_beat.png, /images/django/winservice_beat.png 1.5x, /images/django/winservice_beat.png 2x" data-sizes=auto alt=/images/django/winservice_beat.png title=img></p><p>The new <code>service.py</code> file will contain a section with the name of the current
machine:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[WS2008R2X64]</span>
</span></span><span class=line><span class=cl><span class=c1># There should be only one machine with the celerybeat service</span>
</span></span><span class=line><span class=cl><span class=na>run</span><span class=o>=</span><span class=s>celeryd celerybeat</span>
</span></span><span class=line><span class=cl><span class=na>clean</span><span class=o>=</span><span class=s>d:\logs\celerybeat.pid;d:\logs\beat.log;d:\logs\celery.log</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, when run, the service will start a new python process:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_process_beat.png data-srcset="/images/django/winservice_process_beat.png, /images/django/winservice_process_beat.png 1.5x, /images/django/winservice_process_beat.png 2x" data-sizes=auto alt=/images/django/winservice_process_beat.png title=img></p><p>And new log files for the beat service will be present:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_log_beat.png data-srcset="/images/django/winservice_log_beat.png, /images/django/winservice_log_beat.png 1.5x, /images/django/winservice_log_beat.png 2x" data-sizes=auto alt=/images/django/winservice_log_beat.png title=img></p><h2 id=changes-to-the-configuration>Changes to the configuration</h2><p>The Windows Service monitor changes to the <code>service.ini</code> configuration file. In
case it is modified, the service does the following:</p><ul><li>Stop the background processes.</li><li>Reread the configuration file.</li><li>Start the background processes.</li></ul><p>You may have seen in the <code>service.ini</code> file the <code>runserver</code> section:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl>    <span class=k>[runserver]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Runs the debug server and listen on port 8000</span>
</span></span><span class=line><span class=cl>    <span class=c1># This one is just an example to show that any manage command can be used</span>
</span></span><span class=line><span class=cl>    <span class=na>command</span><span class=o>=</span><span class=s>runserver
</span></span></span><span class=line><span class=cl><span class=s>    parameters=--noreload --insecure 0.0.0.0:8000</span>
</span></span></code></pre></td></tr></table></div></div><p>It allows running the runserver command in a separate process. I you edit the
<code>service.ini</code> file and add <code>runserver</code> to the <code>run</code> directive:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[WS2008R2X64]</span>
</span></span><span class=line><span class=cl><span class=c1># There should be only one machine with the celerybeat service</span>
</span></span><span class=line><span class=cl><span class=na>run</span><span class=o>=</span><span class=s>celeryd celerybeat runserver</span>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span></code></pre></td></tr></table></div></div><p>As soon as you save the file, you can make your browser point to
<code>http://localhost:8000</code> and will obtain:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/django/winservice_runserver.png data-srcset="/images/django/winservice_runserver.png, /images/django/winservice_runserver.png 1.5x, /images/django/winservice_runserver.png 2x" data-sizes=auto alt=/images/django/winservice_runserver.png title=img></p><h2 id=running-arbitrary-commands>Running arbitrary commands</h2><p>As shown in the preceding section, virtually any Django management command can
be run by the service at startup or each time the <code>service.ini</code> file is
modified. You could imagine having a section:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[collectstatic]</span>
</span></span><span class=line><span class=cl><span class=na>command</span><span class=o>=</span><span class=s>collectstatic</span>
</span></span><span class=line><span class=cl><span class=na>parameters</span><span class=o>=</span><span class=s>--noinput</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 02-05&nbsp;<a class=git-hash href=https://github.com/antoinemartin/antoinemartin.github.io/commit/804e55239cc80b131176c3162cfecdfb61035b37 target=_blank title="commit by Antoine Martin(antoine@mindee.co) 804e55239cc80b131176c3162cfecdfb61035b37: ✨ New article on python related sites">
<i class="fas fa-hashtag fa-fw"></i>804e552</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/old/>old</a>,&nbsp;<a href=/tags/obsolete/>obsolete</a>,&nbsp;<a href=/tags/django/>django</a>,&nbsp;<a href=/tags/celery/>celery</a>,&nbsp;<a href=/tags/windows/>windows</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2012/06/27/running-django-under-windows-with-iis-using-fcgi/ class=prev rel=prev title="Running Django Under Windows With Iis Using Fcgi"><i class="fas fa-angle-left fa-fw"></i>Running Django Under Windows With Iis Using Fcgi</a>
<a href=/posts/2012/07/06/installing-redmine-on-centos-6-dot-2-wiht-mysql-and-apache/ class=next rel=next title="Installing Redmine on Centos 6 Dot 2 Wiht Mysql and Apache">Installing Redmine on Centos 6 Dot 2 Wiht Mysql and Apache<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.98.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2012 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://linked.in/in/antoinemartin target=_blank>Antoine Martin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://geekquickies.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:30},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-29953512-1")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-29953512-1" async></script></body></html>